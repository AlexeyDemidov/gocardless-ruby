<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  File: README
  
    &mdash; Documentation by YARD 0.7.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html" title="Index">Index</a> &raquo; 
    <span class="title">File: README</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><div id='filecontents'><h1>GoCardless Ruby Client</h1>

<h2>Introduction</h2>

<p>The GoCardless Ruby client provides a simple Ruby interface to the GoCardless
API. This document covers the usage of the Ruby library, for information on the
structure of the API itself, or for details on particular API resources, read
the <a href="../">API overview</a>.</p>

<p>To use the GoCardless API, you'll need to register your app in the Developer
Panel. Registering an app provides you with an app ID and an app secret. These
are both required to access the API.</p>

<p>To start with, you'll need to create an instance of the <span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">GoCardless::Client</a></span>
class, providing your app id and app secret as arguments to the constructor:</p>

<pre class="code"><span class='client identifier id'>client</span> <span class='assign token'>=</span> <span class='GoCardless constant id'>GoCardless</span><span class='colon2 op'>::</span><span class='Client constant id'>Client</span><span class='lparen token'>(</span><span class='APP_ID constant id'>APP_ID</span><span class='comma token'>,</span> <span class='APP_SECRET constant id'>APP_SECRET</span><span class='rparen token'>)</span>
</pre>

<h2>Linking a Merchant Account with the App</h2>

<p>The API allows you to act on behalf of a merchant. For this to happen, the
merchant must give your app access to their account. This authorization process
results in an access token, which you may then use to act as the merchant via
the API. Note that an app may have access tokens for many merchant accounts.</p>

<p>To authorize your app the merchant must be redirected to the GoCardless
servers, where they will be presented with a page that allows them to link
their account with your app. The URL that you send the merchant to contains
information about your app, as well as the URL where the merchant should be
sent back to once they've completed the process. The Ruby client library takes
care of most of this for you, all you need to provide is the URL:</p>

<pre class="code"><span class='auth_url identifier id'>auth_url</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='authorize_url identifier id'>authorize_url</span><span class='lparen token'>(</span><span class='symbol val'>:redirect_uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'http://mywebsite.com/cb'</span><span class='rparen token'>)</span>
</pre>

<p>Now you need to redirect the merchant to <code>auth_url</code>, so the merchant can give
your app access to their account. If the merchant hasn't already created a
merchant account on GoCardless, they will be prompted to do so first.</p>

<p>Once the merchant has authorized your app, they will be redirected back to the
URL you specified earlier (<code>http://mywebsite.com/cb</code> in the example above). The
API servers will include an &quot;authorization code&quot; as a query string parameter
(<code>code</code>):</p>

<pre class="code"><span class='auth_code identifier id'>auth_code</span> <span class='assign token'>=</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:code</span><span class='rbrack token'>]</span>
</pre>

<p>This authorization code may be exchanged for an access token, which may be used
to access the merchant's account through the API. You can use the
<span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">client</a></span> object to perform the exchange. The <code>redirect_uri</code>
that you used in the previous step must also be provided:</p>

<pre class="code"><span class='client identifier id'>client</span><span class='dot token'>.</span><span class='fetch_access_token identifier id'>fetch_access_token</span><span class='lparen token'>(</span><span class='auth_code identifier id'>auth_code</span><span class='comma token'>,</span> <span class='symbol val'>:redirect_uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'http://mywebsite.com/cb'</span><span class='rparen token'>)</span>
<span class='token identifier id'>token</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='access_token identifier id'>access_token</span>
</pre>

<p>The <code>token</code> is the access token that gives your app access to the merchant's
account. You should store this access token alongside the merchant's record in
your database.</p>

<h2>Retrieving Data from the API</h2>

<p>To access the API on behalf of a merchant, you need to provide the
<span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">client</a></span> object with the access token that corresponds to
the merchant. This may be done by assigning the token to the <code>access_token</code>
attribute:</p>

<pre class="code"><span class='client identifier id'>client</span><span class='dot token'>.</span><span class='access_token identifier id'>access_token</span> <span class='assign token'>=</span> <span class='token identifier id'>token</span>
</pre>

<p>Once your <span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">client</a></span> has a valid access token, you may request
data about the merchant associated with the token. To access the merchant's
information, use the <code>merchant</code> attribute on the client object. This returns an
instance of <span class='object_link'><a href="GoCardless/Merchant.html" title="GoCardless::Merchant (class)">GoCardless::Merchant</a></span>:</p>

<pre class="code"><span class='merchant identifier id'>merchant</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span>  <span class='comment val'># =&gt; &lt;GoCardless::Merchant ...&gt;</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='name identifier id'>name</span>               <span class='comment val'># =&gt; &quot;Harry's Burritos&quot;</span>
</pre>

<p>The <span class='object_link'><a href="GoCardless/Merchant.html" title="GoCardless::Merchant (class)">merchant</a></span> object also provides access to related
data, such as <span class='object_link'><a href="GoCardless/Bill.html" title="GoCardless::Bill (class)">bills</a></span>, <span class='object_link'><a href="GoCardless/Subscription.html" title="GoCardless::Subscription (class)">subscriptions</a></span> and <span class='object_link'><a href="GoCardless/PreAuthorization.html" title="GoCardless::PreAuthorization (class)">pre-authorizations</a></span>:</p>

<pre class="code"><span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='bills identifier id'>bills</span>               <span class='comment val'># =&gt; [&lt;GoCardless::Bill&gt;, ...]</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='subscriptions identifier id'>subscriptions</span>       <span class='comment val'># =&gt; [&lt;GoCardless::Subscription&gt;, ...]</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='pre_authorizations identifier id'>pre_authorizations</span>  <span class='comment val'># =&gt; [&lt;GoCardless::PreAuthorization&gt;, ...]</span>
</pre>

<p>These may also be filtered with various parameters:</p>

<pre class="code"><span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='bills identifier id'>bills</span><span class='lparen token'>(</span><span class='symbol val'>:paid</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>          <span class='comment val'># Only fetches paid bills</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='subscriptions identifier id'>subscriptions</span><span class='lparen token'>(</span><span class='symbol val'>:user_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>1</span><span class='rparen token'>)</span>  <span class='comment val'># User 1's subscriptions</span>
</pre>

<p>Note that each time you use the <span class='object_link'><a href="GoCardless/Client.html#merchant-instance_method" title="GoCardless::Client#merchant (method)">merchant</a></span>
attribute of <span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">GoCardless::Client</a></span>, an API call will be made. So to prevent many
of unnecessary slow calls to the API server from being made, assign the
<span class='object_link'><a href="GoCardless/Merchant.html" title="GoCardless::Merchant (class)">merchant</a></span> object to a variable and use that:</p>

<pre class="code"><span class='comment val'># Rather than this (6 API calls):</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='bills identifier id'>bills</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='subscriptions identifier id'>subscriptions</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='pre_authorizations identifier id'>pre_authorizations</span>

<span class='comment val'># Do this (4 API calls):</span>
<span class='merchant identifier id'>merchant</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='bills identifier id'>bills</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='subscriptions identifier id'>subscriptions</span>
<span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='pre_authorizations identifier id'>pre_authorizations</span>
</pre>

<p>To lookup instances of each resource type by id, accessor methods are provided
on <span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">client</a></span> objects:</p>

<pre class="code"><span class='client identifier id'>client</span><span class='dot token'>.</span><span class='subscription identifier id'>subscription</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span>  <span class='comment val'># =&gt; &lt;GoCardless::Subscription ...&gt;</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='payment identifier id'>payment</span><span class='lparen token'>(</span><span class='integer val'>10</span><span class='rparen token'>)</span>      <span class='comment val'># =&gt; &lt;GoCardless::Payment ...&gt;</span>
</pre>

<h2>Creating new Subscriptions, Pre Authorizations and One-Off Payments</h2>

<p>To set up new subscriptions, pre-authorizations and one-off payments between a
user and merchant account, you need to send the user to the GoCardless site to
approve the process. This is broadly similar to how you link merchant accounts
with your app, the principal difference being that you don't get an access
token at the end of it.</p>

<p>You should pass through certain attributes about the resource that you're
trying to create, such as the payment amount, or the subscription frequency.
These attributes are sent as query-string arguments. For security purposes, the
request must also contain a timestamp, nonce (randomly-generated value),
merchant id and a signature. The <span class='object_link'><a href="GoCardless/Client.html" title="GoCardless::Client (class)">client</a></span> object does this
for you, so you just need to provide the attributes:</p>

<pre class="code"><span class='url identifier id'>url</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='new_subscription_url identifier id'>new_subscription_url</span><span class='lparen token'>(</span><span class='symbol val'>:frequency_unit</span>   <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:week</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:frequency_length</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>6</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:amount</span>           <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>30</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:description</span>      <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'Premium membership'</span><span class='rparen token'>)</span>
</pre>

<p>Redirecting a user to <code>url</code> will take them to a page where they can authorize a
weekly subscription of £30 for a period of 6 weeks. Once they have authorized
the subscription, they will be taken back to your site.</p>

<h2>Creating and modifying bills</h2>

<p>The GoCardless API may also be used to create and modify bills. Bills must be
created on a pre authorization. To create a bill, use the
<span class='object_link'><a href="GoCardless/PreAuthorization.html#create_bill-instance_method" title="GoCardless::PreAuthorization#create_bill (method)">create_bill</a></span> method on
<span class='object_link'><a href="GoCardless/PreAuthorization.html" title="GoCardless::PreAuthorization (class)">PreAuthorization</a></span> objects, providing the amount
in pence as the only argument:</p>

<pre class="code"><span class='bill identifier id'>bill</span> <span class='assign token'>=</span> <span class='pre_authorization identifier id'>pre_authorization</span><span class='dot token'>.</span><span class='create_bill identifier id'>create_bill</span><span class='lparen token'>(</span><span class='integer val'>150</span><span class='rparen token'>)</span>  <span class='comment val'># =&gt; &lt;GoCardless::Bill ...&gt;</span>
</pre>

<p>To modify the bill, alter the attributes and call the
<span class='object_link'><a href="GoCardless/Resource.html#save-instance_method" title="GoCardless::Resource#save (method)">save</a></span> method:</p>

<pre class="code"><span class='bill identifier id'>bill</span><span class='dot token'>.</span><span class='amount identifier id'>amount</span> <span class='assign token'>=</span> <span class='integer val'>250</span>
<span class='bill identifier id'>bill</span><span class='dot token'>.</span><span class='save identifier id'>save</span>
</pre>

<h2>Example usage</h2>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'gocardless'</span>

<span class='comment val'># These are found in the GoCardless app admin interface</span>
<span class='APP_ID constant id'>APP_ID</span> <span class='assign token'>=</span> <span class='string val'>'3QmpV5yi8Ii9Rc2uCwalWRsqkpibtk5ISOk/F+oyzrOoNpjGguZ4IRn2379agARS'</span>
<span class='APP_SECRET constant id'>APP_SECRET</span> <span class='assign token'>=</span> <span class='string val'>'8oCITH2AVhaUYqJ+5hjyt8JUlSo5m/WTYLH8E/GO+TrBWdRK45lvoRt/zetr+t5Y'</span>

<span class='comment val'># Create a new instance of the GoCardless API client</span>
<span class='client identifier id'>client</span> <span class='assign token'>=</span> <span class='GoCardless constant id'>GoCardless</span><span class='colon2 op'>::</span><span class='Client constant id'>Client</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='APP_ID constant id'>APP_ID</span><span class='comma token'>,</span> <span class='APP_SECRET constant id'>APP_SECRET</span><span class='rparen token'>)</span>

<span class='comment val'># Generate the OAuth 'authorize endpoint' URL</span>
<span class='authorize_url identifier id'>authorize_url</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='authorize_url identifier id'>authorize_url</span><span class='lparen token'>(</span><span class='symbol val'>:redirect_uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'http://mywebsite.com/cb'</span><span class='rparen token'>)</span>

<span class='comment val'># Now, redirect the user (merchant) to 'authorize_url'. In Rails this would</span>
<span class='comment val'># look like:</span>
<span class='comment val'>#</span>
<span class='comment val'>#   redirect_to authorize_url</span>
<span class='comment val'>#</span>
<span class='comment val'># They will be presented with a screen where they confirm the link between</span>
<span class='comment val'># their merchant account and your app. Once they are done, they will be</span>
<span class='comment val'># redirected back to the 'redirect_url' you provided.</span>

<span class='comment val'># Now you need to retrieve the authorization code from the query string</span>
<span class='comment val'># parameters:</span>
<span class='comment val'>#</span>
<span class='comment val'>#   auth_code = params[:auth_code]</span>
<span class='comment val'>#</span>
<span class='comment val'># Then exchange the authorization code for an access token:</span>

<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='fetch_access_token identifier id'>fetch_access_token</span><span class='lparen token'>(</span><span class='auth_code identifier id'>auth_code</span><span class='comma token'>,</span> <span class='symbol val'>:redirect_uri</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'http://mywebsite.com/cb'</span><span class='rparen token'>)</span>

<span class='comment val'># The access token should be saved to the database alongside the merchant.</span>
<span class='comment val'># You can get the access token using 'client.access_token'</span>

<span class='comment val'># The API client will be associated with a merchant account</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span>  <span class='comment val'># =&gt; &lt;GoCardless::Merchant ...&gt;</span>

<span class='comment val'># The client allows you to look up most resources by their id</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='subscription identifier id'>subscription</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span>       <span class='comment val'># =&gt; &lt;GoCardless::Subscription ...&gt;</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='pre_authorization identifier id'>pre_authorization</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span>  <span class='comment val'># =&gt; &lt;GoCardless::PreAuthorization ...&gt;</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='bill identifier id'>bill</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span>               <span class='comment val'># =&gt; &lt;GoCardless::Bill ...&gt;</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='payment identifier id'>payment</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span>            <span class='comment val'># =&gt; &lt;GoCardless::Payment ...&gt;</span>

<span class='comment val'># Retrieve referenced resources directly from resource objects</span>
<span class='subscription identifier id'>subscription</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='subscription identifier id'>subscription</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span>
<span class='subscription identifier id'>subscription</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span>  <span class='comment val'># =&gt; &lt;GoCardless::Merchant ...&gt;</span>

<span class='comment val'># To create a new subscription, generate the appropirate URL:</span>
<span class='url identifier id'>url</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='new_subscription_url identifier id'>new_subscription_url</span><span class='lparen token'>(</span><span class='symbol val'>:frequency_unit</span>   <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:week</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:frequency_length</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>6</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:amount</span>           <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>30</span><span class='comma token'>,</span>
                                  <span class='symbol val'>:description</span>      <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'Premium membership'</span><span class='rparen token'>)</span>

<span class='comment val'># Then redirect the user to the URL:</span>
<span class='comment val'>#</span>
<span class='comment val'>#   redirect_to url</span>
<span class='comment val'>#</span>
<span class='comment val'># When the user is redirected back to your site, you need to confirm the</span>
<span class='comment val'># new subscription (assuming params is the query-string parameters):</span>
<span class='subscription identifier id'>subscription</span> <span class='assign token'>=</span> <span class='client identifier id'>client</span><span class='dot token'>.</span><span class='confirm_resource identifier id'>confirm_resource</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='rparen token'>)</span>

<span class='comment val'># Create a new bill via the API under a pre authorization:</span>
<span class='client identifier id'>client</span><span class='dot token'>.</span><span class='merchant identifier id'>merchant</span><span class='dot token'>.</span><span class='pre_authorizations identifier id'>pre_authorizations</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='create_bill identifier id'>create_bill</span><span class='lparen token'>(</span><span class='integer val'>500</span><span class='rparen token'>)</span> <span class='comment val'># £5.00 bill</span>
</pre>
</div></div>
    
    <div id="footer">
  Generated on Fri Aug 12 00:54:33 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.2 (ruby-1.8.7).
</div>

  </body>
</html>